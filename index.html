<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PedsCalc 劑量換算助手</title>

    <!-- PWA Settings -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PedsCalc">
    <link rel="apple-touch-icon" href="Pedscals.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6;
            -webkit-tap-highlight-color: transparent;
        }

        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .step-card {
            transition: all 0.3s ease;
        }

        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Modal Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-animate-fade {
            animation: fadeIn 0.3s ease-out;
        }

        .modal-animate-slide {
            animation: slideUp 0.3s ease-out;
        }

        /* Custom Scrollbar for modal content */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col pb-safe">

    <!-- Navbar -->
    <nav class="bg-blue-600 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-user-doctor text-2xl"></i>
                <h1 class="text-xl font-bold tracking-wide">PedsCalc</h1>
            </div>
            <div class="flex items-center gap-3">
                <!-- Install Button (Hidden by default, shown via JS) -->
                <button id="btnInstallApp"
                    class="hidden bg-white text-blue-600 px-3 py-1 rounded-full text-xs font-bold shadow hover:bg-blue-50 transition-colors flex items-center gap-1">
                    <i class="fas fa-download"></i> <span class="hidden sm:inline">安裝</span>
                </button>
                <span class="text-xs bg-blue-800 px-2 py-1 rounded shadow-inner">v114.12.19</span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-6 max-w-7xl">

        <!-- Warning Banner -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded shadow-sm">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700 font-medium">
                        輔助參考用，請務必再次核對救護流程指引與專業判斷。
                        <br>
                        <span class="text-xs mt-1 block opacity-80">※ 超過 50kg 或成人劑量上限時，系統將自動限制劑量。</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Calculator Form Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-4 mb-8">

            <!-- 1. 病患類型 (Patient Type) -->
            <div
                class="step-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-t-4 border-t-blue-500">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    <i class="fas fa-child mr-1 text-blue-500"></i> 1. 病患類型
                </label>
                <select id="patientType"
                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white outline-none transition-shadow">
                    <option value="child" selected>兒童 (Child)</option>
                    <option value="neonate">新生兒 (Neonate)</option>
                </select>
            </div>

            <!-- 2. 體重數據 (Demographics) -->
            <div
                class="step-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-t-4 border-t-blue-500">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    <i class="fas fa-weight-scale mr-1 text-blue-500"></i> 2. 年齡/體重
                </label>

                <div id="childInputGroup">
                    <!-- Toggle Switch -->
                    <div class="flex mb-3 bg-gray-100 p-1 rounded-lg">
                        <button type="button" id="btnModeAge"
                            class="flex-1 py-1.5 text-xs font-bold rounded-md shadow-sm bg-white text-blue-600 transition-all duration-200">年齡</button>
                        <button type="button" id="btnModeWeight"
                            class="flex-1 py-1.5 text-xs font-bold rounded-md text-gray-500 hover:text-gray-700 transition-all duration-200">體重</button>
                    </div>

                    <!-- Input Fields -->
                    <div id="inputContainerAge">
                        <div class="relative">
                            <input type="number" id="ageInput" max="18" min="0" placeholder="輸入歲數 (Max 18)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <span class="absolute right-3 top-2.5 text-gray-400 text-sm font-medium">歲</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-2 text-right">預估體重: <span id="estWeightDisplay"
                                class="font-bold text-blue-600 text-sm">--</span> kg</p>
                    </div>

                    <div id="inputContainerWeight" class="hidden">
                        <div class="relative">
                            <input type="number" id="weightInput" max="100" placeholder="輸入體重 (Max 100)"
                                class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <span class="absolute right-3 top-2.5 text-gray-400 text-sm font-medium">kg</span>
                        </div>
                    </div>
                </div>

                <!-- Input View for Neonate -->
                <div id="neonateInputGroup" class="hidden">
                    <div class="relative mt-2">
                        <input type="number" id="neonateWeightInput" placeholder="輸入體重 (e.g. 3.5)"
                            class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                        <span class="absolute right-3 top-2.5 text-gray-400 text-sm font-medium">kg</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">新生兒體重上限 5kg</p>
                </div>
            </div>

            <!-- 3. 處置類型 (Intervention) -->
            <div
                class="step-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-t-4 border-t-indigo-500">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    <i class="fas fa-stethoscope mr-1 text-indigo-500"></i> 3. 處置方式
                </label>
                <select id="interventionType"
                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white outline-none">
                    <option value="medication">給藥 (Medication)</option>
                    <option value="shock">電擊 (Defibrillation)</option>
                    <option value="intubation">插管 (Intubation)</option>
                </select>
            </div>

            <!-- 4. 保留選單 (Reserved/Category) -->
            <div
                class="step-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-t-4 border-t-indigo-500">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    <i class="fas fa-list-ul mr-1 text-indigo-500"></i> 4. 分類
                </label>
                <select id="reservedCategory"
                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white outline-none">
                    <option value="arrest" selected>心肺功能停止</option>
                    <option value="general">一般急救</option>
                    <option value="sedation">鎮靜止痛</option>
                </select>
            </div>

            <!-- 5. 給藥途徑 (Route) -->
            <div
                class="step-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-t-4 border-t-purple-500 relative">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    <i class="fas fa-syringe mr-1 text-purple-500"></i> 5. 給藥途徑
                </label>
                <select id="routeType"
                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white outline-none">
                    <!-- Options are now populated by JS -->
                </select>
                <!-- Overlay for disabled state -->
                <div id="routeOverlay"
                    class="hidden absolute inset-0 bg-gray-100 bg-opacity-80 cursor-not-allowed rounded-lg z-10 flex items-center justify-center backdrop-blur-[1px]">
                    <span
                        class="text-gray-500 font-bold text-xs bg-white px-3 py-1.5 rounded-full shadow border">不適用</span>
                </div>
            </div>

            <!-- 6. 藥物/項目選單 (Specific Item) -->
            <div
                class="step-card bg-white p-4 rounded-xl shadow-sm border border-gray-100 border-t-4 border-t-purple-500">
                <label id="itemLabel" class="block text-sm font-bold text-gray-700 mb-2">
                    <i class="fas fa-pills mr-1 text-purple-500"></i> 6. 選擇項目
                </label>
                <select id="specificItem"
                    class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white outline-none text-sm">
                    <!-- Dynamic Options -->
                </select>
            </div>

        </div>

        <!-- Result Section -->
        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden mb-8">
            <div
                class="bg-gray-800 text-white px-6 py-4 flex justify-between items-center bg-gradient-to-r from-gray-800 to-gray-700">
                <h2 class="text-lg font-bold flex items-center"><i
                        class="fas fa-calculator mr-2 text-yellow-400"></i>計算結果</h2>
                <div class="text-xs md:text-sm bg-gray-900 bg-opacity-50 px-3 py-1 rounded-full">
                    計算基礎體重: <span id="displayCalcWeight" class="font-mono font-bold text-yellow-400 text-base">0</span>
                    kg
                </div>
            </div>

            <div class="p-6 grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                <!-- Main Result -->
                <div class="text-center lg:text-left flex flex-col justify-center h-full">
                    <p class="text-xs text-gray-500 uppercase tracking-wider font-bold mb-2">建議劑量 / 尺寸</p>
                    <div class="flex items-baseline justify-center lg:justify-start gap-2 flex-wrap">
                        <span id="resultValue"
                            class="text-5xl md:text-6xl font-black text-blue-600 tracking-tight leading-none transition-all duration-300">---</span>
                        <span id="resultUnit" class="text-xl md:text-2xl text-gray-500 font-medium"></span>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100 inline-block lg:block">
                        <p id="resultDetail" class="text-blue-800 font-medium text-sm md:text-base">請選擇參數以開始計算</p>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="bg-gray-50 rounded-xl p-5 border border-gray-200 shadow-inner">
                    <h3 class="text-gray-800 font-bold text-sm mb-3 flex items-center">
                        <i class="fas fa-info-circle mr-2 text-blue-500"></i>藥物/處置資訊
                    </h3>
                    <ul class="text-sm space-y-3">
                        <li class="flex border-b border-gray-200 pb-2">
                            <span class="font-medium text-gray-500 w-24 shrink-0">標準劑量</span>
                            <span id="infoStandard" class="text-gray-900 font-semibold break-words">---</span>
                        </li>
                        <li class="flex border-b border-gray-200 pb-2">
                            <span class="font-medium text-gray-500 w-24 shrink-0">最大劑量</span>
                            <span id="infoMax" class="text-gray-900 font-semibold">無</span>
                        </li>
                        <li class="flex border-b border-gray-200 pb-2">
                            <span class="font-medium text-gray-500 w-24 shrink-0">建議部位</span>
                            <span id="infoSite" class="text-gray-900 break-words">---</span>
                        </li>
                        <li class="flex">
                            <span class="font-medium text-gray-500 w-24 shrink-0">注意事項</span>
                            <span id="infoNote" class="text-red-600 font-bold break-words">---</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Reference Section: Intubation Sizes -->
            <div class="bg-indigo-50 border-t border-indigo-100 px-6 py-4">
                <div class="flex items-center gap-2 mb-3">
                    <i class="fa-solid fa-lungs text-indigo-500"></i>
                    <span class="text-sm font-bold text-indigo-900">建議插管器材參考 (Reference)</span>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-indigo-900">
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-indigo-100">
                        <span class="text-indigo-400 block text-xs uppercase font-bold mb-1">無氣囊 (Uncuffed)</span>
                        <span id="refEttUncuffed" class="font-bold text-2xl text-indigo-700">--</span>
                        <span class="text-xs text-gray-400 ml-1">mm</span>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-indigo-100">
                        <span class="text-indigo-400 block text-xs uppercase font-bold mb-1">有氣囊 (Cuffed)</span>
                        <span id="refEttCuffed" class="font-bold text-2xl text-indigo-700">--</span>
                        <span class="text-xs text-gray-400 ml-1">mm</span>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-indigo-100">
                        <span class="text-indigo-400 block text-xs uppercase font-bold mb-1">深度 (Depth)</span>
                        <span id="refEttDepth" class="font-bold text-xl text-indigo-700">--</span>
                        <span class="text-xs text-gray-400 ml-1">cm</span>
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm border border-indigo-100">
                        <span class="text-indigo-400 block text-xs uppercase font-bold mb-1">葉片 (Blade)</span>
                        <span id="refBlade" class="font-bold text-xl text-indigo-700">--</span>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer with Author and Disclaimer Button -->
    <footer class="bg-gray-800 text-gray-400 py-8 mt-auto">
        <div class="container mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-6">
            <div class="text-center md:text-left">
                <p class="text-sm font-medium text-white mb-2">作者: 莊進宏</p>
                <button id="btnDisclaimer"
                    class="text-xs text-blue-400 hover:text-blue-300 underline transition-colors flex items-center mx-auto md:mx-0">
                    <i class="fas fa-shield-alt mr-1"></i> 免責聲明
                </button>
            </div>
            <div class="text-center md:text-right text-xs text-gray-500 space-y-1">
                <p class="font-bold text-gray-400 mb-2">參考文獻來源</p>
                <p>2020 American Heart Association Guidelines</p>
                <p>114年臺南市政府消防局緊急救護流程指引</p>
                <p>胡勝川、張茵琇、張宇勳 PALS與APLS精華第三版</p>
                <p>紀煥庭醫師 新生兒及小兒急救流程圖</p>
            </div>
        </div>
    </footer>

    <!-- Disclaimer Modal -->
    <div id="modalDisclaimer"
        class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4 modal-animate-fade backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 relative modal-animate-slide border border-gray-200 flex flex-col max-h-[90vh]">
            <button id="btnCloseModal"
                class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors p-2">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="text-center mb-4 flex-shrink-0">
                <div
                    class="w-14 h-14 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-3 shadow-inner">
                    <i class="fas fa-info-circle text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800">免責聲明</h3>
            </div>

            <div class="text-gray-600 text-sm leading-relaxed space-y-3 overflow-y-auto custom-scrollbar px-2">
                <p class="font-medium text-gray-800">請仔細閱讀以下聲明：</p>
                <p>1. 本工具僅供<span class="font-bold text-red-500">高級救護技術員</span>緊急救護輔助參考使用，並非絕對醫療指引。</p>
                <p>2. 雖然作者已盡力確保數據正確，但實際給藥劑量、電擊能量與器材選擇，仍請務必再次核對當前最新的醫療指引與考量病患實際臨床狀況。</p>
                <p>3. 作者不對因使用本工具而產生的任何直接或間接損害負責。</p>
                <p>4. 使用者應自行驗證所有計算結果的正確性與適用性。</p>
                <p>5. 使用本工具即表示您已閱讀並同意上述條款。</p>
                <div class="bg-yellow-50 p-3 rounded text-yellow-800 text-xs border border-yellow-200 mt-2">
                    <i class="fas fa-clock mr-1"></i> 最後更新: 2025/12/19
                </div>
            </div>

            <div class="mt-6 flex-shrink-0">
                <button id="btnConfirmModal"
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition shadow-lg active:transform active:scale-95 flex items-center justify-center">
                    <i class="fas fa-check-circle mr-2"></i> 我瞭解了
                </button>
            </div>
        </div>
    </div>

    <!-- PWA Install Instruction Modal (iOS/Manual) -->
    <div id="modalInstallInstruction"
        class="fixed inset-0 bg-black bg-opacity-70 z-50 hidden flex items-center justify-center p-4 modal-animate-fade backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 relative modal-animate-slide border border-gray-200">
            <button id="btnCloseInstall"
                class="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition-colors p-2">
                <i class="fas fa-times text-xl"></i>
            </button>

            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-blue-600 text-white rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg text-3xl">
                    <i class="fas fa-user-doctor"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-800">安裝 PedsCalc</h3>
                <p class="text-sm text-gray-500 mt-1">將此 App 加入主畫面以便離線使用</p>
            </div>

            <div class="space-y-4">
                <!-- iOS Instructions -->
                <div id="iosInstructions" class="hidden">
                    <ol class="text-sm text-gray-600 space-y-3 leading-relaxed">
                        <li class="flex items-start">
                            <span
                                class="bg-gray-100 text-gray-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">1</span>
                            <span>點擊瀏覽器下方的分享按鈕 <img src="https://img.icons8.com/ios/50/000000/upload--v1.png"
                                    class="w-5 h-5 inline align-middle opacity-70"></span>
                        </li>
                        <li class="flex items-start">
                            <span
                                class="bg-gray-100 text-gray-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">2</span>
                            <span>往下滑動並選擇「加入主畫面」<br><span class="text-xs text-gray-400">(Add to Home
                                    Screen)</span></span>
                        </li>
                        <li class="flex items-start">
                            <span
                                class="bg-gray-100 text-gray-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">3</span>
                            <span>點擊右上角的「加入」即可。</span>
                        </li>
                    </ol>
                </div>

                <!-- Android/Other Instructions (Fallback) -->
                <div id="androidInstructions" class="hidden">
                    <ol class="text-sm text-gray-600 space-y-3 leading-relaxed">
                        <li class="flex items-start">
                            <span
                                class="bg-gray-100 text-gray-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">1</span>
                            <span>點擊瀏覽器右上角的選單圖示 <i class="fas fa-ellipsis-v text-gray-400 mx-1"></i></span>
                        </li>
                        <li class="flex items-start">
                            <span
                                class="bg-gray-100 text-gray-600 rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold mr-3 flex-shrink-0">2</span>
                            <span>選擇「安裝應用程式」或「加到主畫面」。</span>
                        </li>
                    </ol>
                </div>
            </div>

            <div class="mt-6 text-center">
                <button id="btnCloseInstallConfirm"
                    class="w-full bg-gray-100 text-gray-700 font-bold py-3 rounded-xl hover:bg-gray-200 transition">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- Logic Script -->
    <script>
        // --- 1. Data Structure ---
        const weightChart = {
            1: 10,
            2: 12,
            3: 14,
            4: 16,
            5: 18,
            6: 20,
            7: 22,
            8: 25,
            9: 28
        };

        const routesData = [
            { value: 'iv_io', text: 'IV/IO (靜脈/骨內)' },
            { value: 'im', text: 'IM (肌肉注射)' },
            { value: 'endo', text: 'Endo (氣管內管)' },
            { value: 'iv', text: 'IV (靜脈)' }
        ];

        const database = {
            medications: [
                { id: 'epi', name: 'Epinephrine (1:10000)', dose: 0.01, unit: 'mg/kg', resultUnit: 'mg', volConc: 0.1, volUnit: 'ml/kg (1:10000)', route: ['iv_io'], max: '1 mg (Adult)', note: '心跳停止時每 3-5 分鐘給予' },
                { id: 'epi_im', name: 'Epinephrine (1:1000)', dose: 0.01, unit: 'mg/kg', resultUnit: 'mg', volConc: 0.01, volUnit: 'ml/kg (1:1000)', route: ['im'], max: '0.5 mg (Adult)', note: '過敏性休克使用' },
                { id: 'epi_endo', name: 'Epinephrine (Endo)', dose: 0.1, unit: 'mg/kg', resultUnit: 'mg', volConc: 0.1, volUnit: 'ml/kg', route: ['endo'], max: '2.5 mg', note: '氣管內管給藥: 建議劑量 0.1 mg/kg (IV 劑量的 10 倍)用3~5ml生理食鹽水按壓甦醒球5次。' },
                { id: 'amio', name: 'Amiodarone', dose: 5, unit: 'mg/kg', resultUnit: 'mg', volConc: 0.1, volUnit: 'ml/kg', route: ['iv_io'], max: '300 mg (Adult)', note: '可再重複兩次(總共三次)，最大總劑量 15 mg/kg' },

            ],
            shocks: [
                { id: 'defib_2j', name: 'Defibrillation (第一次去顫電擊) 2 J/kg', dose: 2, unit: 'J/kg', resultUnit: 'Joules', max: '200 J (Adult Biphasic)', note: '第一次電擊' },
                { id: 'defib_4j', name: 'Defibrillation (第二次去顫電擊) 4 J/kg', dose: 4, unit: 'J/kg', resultUnit: 'Joules', max: '200 J (Adult Biphasic)', note: '第二次及後續電擊' },
            ],
            intubations: [
                { id: 'ett_uncuffed', name: 'ETT Size (Uncuffed)', unit: 'mm ID', note: '公式: (年齡/4) + 4，無氣囊' },
                { id: 'ett_cuffed', name: 'ETT Size (Cuffed)', unit: 'mm ID', note: '公式: (年齡/4) + 3.5，有氣囊' },
                { id: 'ett_depth', name: 'Insertion Depth (Lip)', unit: 'cm', note: '鼻耳(鼻中膈-耳屏+1cm)；號數*3 ; 12+(age/2)' },
                { id: 'blade', name: 'Laryngoscope Blade', unit: 'Size', note: '喉鏡葉片建議尺寸' }
            ]
        };

        // --- 2. State Management ---
        const state = {
            patientType: 'child',   // child | neonate
            inputMode: 'age',       // age | weight
            age: '',
            weightInput: '',
            neonateWeightInput: '',
            finalWeight: 0,
            intervention: 'medication',
            category: 'arrest',     // Default to match HTML 'selected'
            route: 'iv_io',
            selectedItemId: ''
        };

        // --- 3. DOM Elements ---
        const els = {
            patientType: document.getElementById('patientType'),
            btnModeAge: document.getElementById('btnModeAge'),
            btnModeWeight: document.getElementById('btnModeWeight'),
            inputContainerAge: document.getElementById('inputContainerAge'),
            inputContainerWeight: document.getElementById('inputContainerWeight'),
            neonateInputGroup: document.getElementById('neonateInputGroup'),
            childInputGroup: document.getElementById('childInputGroup'),
            ageInput: document.getElementById('ageInput'),
            weightInput: document.getElementById('weightInput'),
            neonateWeightInput: document.getElementById('neonateWeightInput'),
            estWeightDisplay: document.getElementById('estWeightDisplay'),
            interventionType: document.getElementById('interventionType'),
            reservedCategory: document.getElementById('reservedCategory'),
            routeType: document.getElementById('routeType'),
            routeOverlay: document.getElementById('routeOverlay'),
            specificItem: document.getElementById('specificItem'),
            itemLabel: document.getElementById('itemLabel'),
            // Results
            displayCalcWeight: document.getElementById('displayCalcWeight'),
            resultValue: document.getElementById('resultValue'),
            resultUnit: document.getElementById('resultUnit'),
            resultDetail: document.getElementById('resultDetail'),
            infoStandard: document.getElementById('infoStandard'),
            infoMax: document.getElementById('infoMax'),
            infoSite: document.getElementById('infoSite'),
            infoNote: document.getElementById('infoNote'),
            // Reference Section
            refEttUncuffed: document.getElementById('refEttUncuffed'),
            refEttCuffed: document.getElementById('refEttCuffed'),
            refEttDepth: document.getElementById('refEttDepth'),
            refBlade: document.getElementById('refBlade'),
            // Install Button
            btnInstallApp: document.getElementById('btnInstallApp')
        };

        // --- 4. Logic Functions ---

        function init() {
            updateInputVisibility();
            updateRouteOptions();
            updateInterventionUI();
            addListeners();
            calculate();
            registerServiceWorker(); // PWA Registration
            initInstallPrompt(); // Handle Install Button
        }

        // PWA: Service Worker Registration
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js')
                        .then(registration => {
                            console.log('SW Registered');
                        }, err => {
                            console.log('SW Registration Failed: ', err);
                        });
                });
            }
        }

        // PWA: Install Prompt Logic
        let deferredPrompt;
        function initInstallPrompt() {
            const btn = els.btnInstallApp;
            const modalInstall = document.getElementById('modalInstallInstruction');
            const btnCloseInstall = document.getElementById('btnCloseInstall');
            const btnCloseInstallConfirm = document.getElementById('btnCloseInstallConfirm');
            const iosInstructions = document.getElementById('iosInstructions');
            const androidInstructions = document.getElementById('androidInstructions');

            // Detect iOS
            const isIos = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            // Detect if already standalone (installed)
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;

            // Always show button on iOS if not installed (since iOS doesn't fire event)
            if (isIos && !isStandalone) {
                btn.classList.remove('hidden');
            }

            // Android/Chrome: Capture the event
            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent Chrome 67 and earlier from automatically showing the prompt
                e.preventDefault();
                // Stash the event so it can be triggered later.
                deferredPrompt = e;
                // Update UI to notify the user they can add to home screen
                btn.classList.remove('hidden');
            });

            // Handle Button Click
            btn.addEventListener('click', (e) => {
                if (deferredPrompt) {
                    // Show the prompt
                    deferredPrompt.prompt();
                    // Wait for the user to respond to the prompt
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the A2HS prompt');
                            btn.classList.add('hidden'); // Hide button after install
                        } else {
                            console.log('User dismissed the A2HS prompt');
                        }
                        deferredPrompt = null;
                    });
                } else {
                    // Manual Instructions needed (iOS or Fallback)
                    modalInstall.classList.remove('hidden');
                    if (isIos) {
                        iosInstructions.classList.remove('hidden');
                        androidInstructions.classList.add('hidden');
                    } else {
                        androidInstructions.classList.remove('hidden');
                        iosInstructions.classList.add('hidden');
                    }
                }
            });

            // Close Modal Logic
            function closeInstallModal() {
                modalInstall.classList.add('hidden');
            }
            if (btnCloseInstall) btnCloseInstall.addEventListener('click', closeInstallModal);
            if (btnCloseInstallConfirm) btnCloseInstallConfirm.addEventListener('click', closeInstallModal);

            // Hide button if installed
            if (isStandalone) {
                btn.classList.add('hidden');
            }
        }


        function updateRouteOptions() {
            if (state.category === 'sedation') {
                els.routeType.innerHTML = '<option value="">未開放</option>';
                els.routeType.disabled = true;
                state.route = '';
                populateSpecificItems();
                return;
            }

            let allowedRoutes = [];
            if (state.category === 'arrest') {
                allowedRoutes = ['iv_io', 'endo'];
            } else if (state.category === 'general') {
                allowedRoutes = ['im', 'iv'];
            }

            const currentSelection = els.routeType.value;
            els.routeType.innerHTML = '';

            routesData.forEach(r => {
                if (allowedRoutes.includes(r.value)) {
                    const opt = document.createElement('option');
                    opt.value = r.value;
                    if (state.patientType === 'neonate' && r.value === 'iv_io') {
                        opt.text = 'UVC/IO(臍靜脈/骨內)';
                    } else {
                        opt.text = r.text;
                    }
                    els.routeType.appendChild(opt);
                }
            });

            if (currentSelection && allowedRoutes.includes(currentSelection)) {
                els.routeType.value = currentSelection;
            } else {
                els.routeType.value = allowedRoutes[0];
            }
            state.route = els.routeType.value;
            populateSpecificItems();
        }

        function updateInputVisibility() {
            const shockOption = els.interventionType.querySelector('option[value="shock"]');
            const generalOption = els.reservedCategory.querySelector('option[value="general"]');
            const sedationOption = els.reservedCategory.querySelector('option[value="sedation"]');

            if (state.patientType === 'neonate') {
                if (shockOption) {
                    shockOption.hidden = true;
                    shockOption.disabled = true;
                }
                if (state.intervention === 'shock') {
                    state.intervention = 'medication';
                    els.interventionType.value = 'medication';
                    updateInterventionUI();
                }

                if (generalOption) generalOption.hidden = true;
                if (sedationOption) sedationOption.hidden = true;

                if (state.category === 'general' || state.category === 'sedation') {
                    state.category = 'arrest';
                    els.reservedCategory.value = 'arrest';
                    updateRouteOptions();
                    updateInterventionUI();
                }

            } else {
                if (shockOption) {
                    shockOption.hidden = false;
                    shockOption.disabled = false;
                }
                if (generalOption) generalOption.hidden = false;
                if (sedationOption) sedationOption.hidden = false;
            }

            if (state.patientType === 'neonate') {
                els.childInputGroup.classList.add('hidden');
                els.neonateInputGroup.classList.remove('hidden');
            } else {
                els.neonateInputGroup.classList.add('hidden');
                els.childInputGroup.classList.remove('hidden');

                if (state.inputMode === 'age') {
                    els.inputContainerAge.classList.remove('hidden');
                    els.inputContainerWeight.classList.add('hidden');
                    els.btnModeAge.classList.replace('text-gray-500', 'text-blue-600');
                    els.btnModeAge.classList.add('bg-white', 'shadow-sm');
                    els.btnModeWeight.classList.replace('text-blue-600', 'text-gray-500');
                    els.btnModeWeight.classList.remove('bg-white', 'shadow-sm');
                } else {
                    els.inputContainerAge.classList.add('hidden');
                    els.inputContainerWeight.classList.remove('hidden');
                    els.btnModeWeight.classList.replace('text-gray-500', 'text-blue-600');
                    els.btnModeWeight.classList.add('bg-white', 'shadow-sm');
                    els.btnModeAge.classList.replace('text-blue-600', 'text-gray-500');
                    els.btnModeAge.classList.remove('bg-white', 'shadow-sm');
                }
            }
            updateStateWeight();
        }

        function calculateWeightFromAge(age) {
            if (!age || age < 0) return 0;
            const ageNum = parseFloat(age);
            const roundedAge = Math.round(ageNum);
            if (roundedAge >= 1 && roundedAge <= 9) {
                if (weightChart[roundedAge]) return weightChart[roundedAge];
            }
            if (ageNum < 1) return (ageNum * 12 * 0.5) + 4;
            if (ageNum > 9) return (ageNum * 3) + 7;
            return (ageNum + 4) * 2;
        }

        function updateStateWeight() {
            if (state.patientType === 'neonate') {
                state.finalWeight = parseFloat(state.neonateWeightInput) || 0;
            } else {
                if (state.inputMode === 'age') {
                    const w = calculateWeightFromAge(state.age);
                    state.finalWeight = w;
                    els.estWeightDisplay.innerText = w > 0 ? w.toFixed(1) : '--';
                } else {
                    state.finalWeight = parseFloat(state.weightInput) || 0;
                }
            }
            els.displayCalcWeight.innerText = state.finalWeight > 0 ? state.finalWeight.toFixed(1) : '0';
        }

        function updateInterventionUI() {
            if (state.intervention === 'shock') {
                els.reservedCategory.innerHTML = '<option value="">不適用</option>';
                els.reservedCategory.disabled = true;
                state.category = 'na';
            }
            else if (state.intervention === 'intubation') {
                els.reservedCategory.innerHTML = '<option value="arrest">心肺功能停止</option>';
                els.reservedCategory.value = 'arrest';
                els.reservedCategory.disabled = true;
                state.category = 'arrest';
                updateRouteOptions();
            }
            else {
                if (els.reservedCategory.disabled) {
                    const isNeonate = state.patientType === 'neonate';
                    els.reservedCategory.innerHTML = `
                        <option value="arrest">心肺功能停止</option>
                        <option value="general" ${isNeonate ? 'hidden' : ''}>一般急救</option>
                        <option value="sedation" ${isNeonate ? 'hidden' : ''}>鎮靜止痛</option>
                    `;
                    els.reservedCategory.disabled = false;
                    els.reservedCategory.value = 'arrest';
                    state.category = 'arrest';
                    updateRouteOptions();
                }
            }

            if (state.category === 'sedation') {
                els.routeOverlay.classList.add('hidden');
                els.routeType.disabled = true;
                els.itemLabel.innerText = '選擇藥物';
                populateSpecificItems();
                return;
            }

            if (state.intervention === 'shock' || state.intervention === 'intubation') {
                els.routeOverlay.classList.remove('hidden');
                els.routeType.disabled = true;
                els.itemLabel.innerText = state.intervention === 'shock' ? '選擇能量' : '選擇器材';
            } else {
                els.routeOverlay.classList.add('hidden');
                els.routeType.disabled = false;
                els.itemLabel.innerText = '選擇藥物';
            }
            populateSpecificItems();
        }

        function populateSpecificItems() {
            els.specificItem.innerHTML = '';
            if (state.category === 'sedation') {
                els.specificItem.innerHTML = '<option value="">未開放</option>';
                els.specificItem.disabled = true;
                state.selectedItemId = '';
                els.resultValue.innerText = '---';
                els.resultDetail.innerText = '此功能尚未開放';
                els.infoStandard.innerText = '---';
                els.infoMax.innerText = '---';
                els.infoNote.innerText = '---';
                els.infoSite.parentElement.classList.add('hidden');
                return;
            }

            if (state.category === 'general' && state.route === 'iv') {
                els.specificItem.innerHTML = '<option value="">未開放</option>';
                els.specificItem.disabled = true;
                state.selectedItemId = '';
                els.resultValue.innerText = '---';
                els.resultDetail.innerText = '此功能尚未開放';
                els.infoStandard.innerText = '---';
                els.infoMax.innerText = '---';
                els.infoNote.innerText = '---';
                els.infoSite.parentElement.classList.add('hidden');
                return;
            }

            els.specificItem.disabled = false;
            let items = [];
            if (state.intervention === 'shock') {
                items = database.shocks;
            } else if (state.intervention === 'intubation') {
                items = database.intubations;
            } else {
                items = database.medications.filter(med => med.route.includes(state.route));
            }

            if (state.patientType === 'neonate') {
                items = items.filter(i => i.id !== 'amio');
            }

            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item.id;
                opt.text = item.name;
                els.specificItem.appendChild(opt);
            });

            if (items.length > 0) {
                state.selectedItemId = items[0].id;
                calculate();
            } else {
                state.selectedItemId = '';
                els.resultValue.innerText = '---';
                els.resultDetail.innerText = '此途徑無適用項目';
            }
        }

        function calculate() {
            updateStateWeight();
            updateReferenceValues();

            if (state.finalWeight <= 0) {
                els.resultValue.innerText = '---';
                els.resultDetail.innerText = '請先輸入有效的年齡或體重';
                return;
            }

            if (!state.selectedItemId) return;

            let item;
            if (state.intervention === 'shock') {
                item = database.shocks.find(i => i.id === state.selectedItemId);
            } else if (state.intervention === 'intubation') {
                item = database.intubations.find(i => i.id === state.selectedItemId);
            } else {
                item = database.medications.find(i => i.id === state.selectedItemId);
            }

            if (!item) return;

            els.resultValue.classList.remove('text-3xl', 'text-2xl', 'md:text-4xl');
            els.resultValue.classList.add('text-5xl', 'md:text-6xl');

            if (state.intervention === 'intubation') {
                calculateIntubation(item);
                return;
            }

            if (state.patientType === 'neonate' && item.id === 'epi') {
                els.resultValue.classList.remove('text-5xl', 'md:text-6xl');
                els.resultValue.classList.add('text-3xl', 'md:text-4xl');
                const multipliers = [0.01, 0.02, 0.03];
                const results = multipliers.map(m => state.finalWeight * m);
                const resultText = results.map(v => {
                    let s = v < 1 ? v.toFixed(2) : v.toFixed(1);
                    return parseFloat(s);
                }).join(' / ');
                els.resultValue.innerText = resultText;
                els.resultUnit.innerText = item.resultUnit;
                const volumes = results.map(v => (v / 0.1).toFixed(1)).join(' / ');
                els.resultDetail.innerText = `參考體積: ${volumes} ml (約 ${volumes} c.c.)`;
                els.infoStandard.innerText = "0.01 ~ 0.03 mg/kg (1:10000)";
                els.infoMax.innerText = "無";
                els.infoNote.innerText = item.note;
            }
            else if (state.patientType === 'neonate' && item.id === 'epi_endo') {
                els.resultValue.classList.remove('text-5xl', 'md:text-6xl');
                els.resultValue.classList.add('text-3xl', 'md:text-4xl');
                const multipliers = [0.05, 0.1];
                const results = multipliers.map(m => state.finalWeight * m);
                const resultText = results.map(v => {
                    let s = v < 1 ? v.toFixed(2) : v.toFixed(1);
                    return parseFloat(s);
                }).join(' ~ ');
                els.resultValue.innerText = resultText;
                els.resultUnit.innerText = item.resultUnit;
                const volumes = results.map(v => (v / 0.1).toFixed(1)).join(' / ');
                els.resultDetail.innerText = `參考體積: ${volumes} ml (約 ${volumes} c.c.)`;
                els.infoStandard.innerText = "0.05mg/kg~0.1mg/kg(1:10000)";
                els.infoMax.innerText = "無";
                els.infoNote.innerText = "氣管內管給藥";
            }
            else {
                let val = state.finalWeight * item.dose;
                let isCapped = false;
                let maxVal = parseFloat(item.max);
                if (!isNaN(maxVal) && val > maxVal) {
                    val = maxVal;
                    isCapped = true;
                }
                let displayVal = val < 1 ? val.toFixed(2) : val.toFixed(1);
                if (Number.isInteger(parseFloat(displayVal))) {
                    displayVal = parseInt(displayVal);
                }
                els.resultValue.innerText = displayVal;
                els.resultUnit.innerText = item.resultUnit;
                if (state.intervention === 'medication' && item.volConc) {
                    let vol = (val / (item.dose / item.volConc)).toFixed(1);
                    els.resultDetail.innerText = `參考體積: 約 ${vol} ml (約 ${vol} c.c.)`;
                } else {
                    els.resultDetail.innerText = isCapped ? '(已達成人/最大建議劑量)' : `計算公式: ${state.finalWeight.toFixed(1)}kg × ${item.dose} ${item.unit}`;
                }
                if (item.id === 'epi') {
                    els.infoStandard.innerText = `${item.dose} ${item.unit} (1:10000)`;
                } else {
                    els.infoStandard.innerText = `${item.dose} ${item.unit}`;
                }
                els.infoMax.innerText = item.max;
                els.infoNote.innerText = item.note;
            }

            if (state.intervention === 'shock') {
                els.infoSite.innerText = "使用兒童貼片，若無則使用大人貼片 (前胸後背)";
                els.infoSite.parentElement.classList.remove('hidden');
            } else if (state.route === 'im') {
                els.infoSite.innerText = "第一優先:大腿前外側肌 / 第二優先:肩峰下三指幅三角肌";
                els.infoSite.parentElement.classList.remove('hidden');
            } else if (state.route === 'iv_io') {
                if (state.patientType === 'neonate') {
                    els.infoSite.innerText = "UVC / IO (Distal femur / 遠端股骨、Proximal tibia / 近端脛骨、Distal tibia / 遠端脛骨。)";
                } else {
                    els.infoSite.innerText = "IV / IO (Distal femur / 遠端股骨、Proximal tibia / 近端脛骨、Distal tibia / 遠端脛骨。)";
                }
                els.infoSite.parentElement.classList.remove('hidden');
            } else if (state.route === 'endo') {
                els.infoSite.innerText = "氣管內管 (ETT)";
                els.infoSite.parentElement.classList.remove('hidden');
            } else {
                els.infoSite.parentElement.classList.add('hidden');
            }
        }

        function calculateIntubation(item) {
            let result = '';
            let note = item.note;
            if (state.patientType === 'neonate' && item.id === 'ett_depth') {
                note = "1.體重+6。2.鼻耳(鼻中膈-耳屏+1cm)。";
            }
            const calcAge = getCalculatedAge();

            if (item.id === 'blade') {
                if (state.patientType === 'neonate' || state.finalWeight < 4) result = '0 - 1 (Straight)';
                else if (calcAge < 2) result = '1 (Straight)';
                else if (calcAge < 5) result = '1.5 - 2';
                else result = '2 - 3';
                els.resultValue.innerText = result;
            }
            else if (item.id.includes('ett') && !item.id.includes('depth')) {
                let baseUncuffed = 0;
                if (state.patientType === 'neonate' || state.finalWeight < 3) {
                    if (state.finalWeight < 1) baseUncuffed = 2.5;
                    else if (state.finalWeight < 2) baseUncuffed = 3.0;
                    else baseUncuffed = 3.5;
                } else {
                    if (calcAge < 1) baseUncuffed = 3.5;
                    else baseUncuffed = (calcAge / 4) + 4;
                }
                if (baseUncuffed > 7.0) baseUncuffed = 7.0;
                let finalSize = 0;
                if (item.id === 'ett_uncuffed') {
                    finalSize = baseUncuffed;
                } else {
                    finalSize = baseUncuffed - 0.5;
                }
                els.resultValue.innerText = (Math.round(finalSize * 2) / 2).toFixed(1);
            }
            else if (item.id === 'ett_depth') {
                if (state.patientType === 'neonate') {
                    els.resultValue.innerText = (state.finalWeight + 6).toFixed(1);
                    els.resultValue.classList.remove('text-3xl', 'md:text-4xl');
                    els.resultValue.classList.add('text-5xl', 'md:text-6xl');
                } else {
                    let tempUncuffed = 3.5;
                    if (calcAge >= 1) tempUncuffed = (calcAge / 4) + 4;
                    if (calcAge < 1 && state.finalWeight > 0) {
                        if (state.finalWeight < 1) tempUncuffed = 2.5;
                        else if (state.finalWeight < 2) tempUncuffed = 3.0;
                        else tempUncuffed = 3.5;
                    }
                    if (tempUncuffed > 7.0) tempUncuffed = 7.0;
                    let tempCuffed = tempUncuffed - 0.5;
                    if (tempCuffed < 2.0) tempCuffed = 2.0;
                    let depthUncuffed = (tempUncuffed * 3).toFixed(1);
                    let depthCuffed = (tempCuffed * 3).toFixed(1);
                    let sizeX3String = `號數x3 (U:${depthUncuffed} / C:${depthCuffed})`;
                    let displayString = sizeX3String;
                    if (state.inputMode === 'age') {
                        let dAge = (12 + (calcAge / 2)).toFixed(1);
                        displayString = `年齡公式: ${dAge} `;
                    }
                    els.resultValue.innerText = displayString;
                    els.resultValue.classList.remove('text-5xl', 'md:text-6xl');
                    els.resultValue.classList.add('text-2xl', 'md:text-4xl');
                }
            }
            els.resultUnit.innerText = item.unit;
            els.resultDetail.innerText = note;
            els.infoStandard.innerText = "依病患體型換算";
            els.infoMax.innerText = "無";
            els.infoNote.innerText = note;
            els.infoSite.parentElement.classList.add('hidden');
        }

        function getCalculatedAge() {
            let calcAge = 0;
            if (state.patientType === 'neonate') {
                calcAge = 0;
            } else if (state.inputMode === 'age' && state.age) {
                calcAge = parseFloat(state.age);
            } else {
                if (state.finalWeight < 10) calcAge = 0.5;
                else calcAge = (state.finalWeight / 2) - 4;
                if (calcAge < 0) calcAge = 0;
            }
            return calcAge;
        }

        function updateReferenceValues() {
            if (state.finalWeight <= 0) {
                els.refEttUncuffed.innerText = '--';
                els.refEttCuffed.innerText = '--';
                els.refEttDepth.innerText = '--';
                els.refBlade.innerText = '--';
                return;
            }
            const calcAge = getCalculatedAge();
            let blade = '';
            if (state.patientType === 'neonate' || state.finalWeight < 4) blade = '0-1 (Str)';
            else if (calcAge < 2) blade = '1 (Str)';
            else if (calcAge < 5) blade = '1.5-2';
            else blade = '2-3';
            els.refBlade.innerText = blade;

            let uncuffed = 0;
            if (state.patientType === 'neonate' || state.finalWeight < 3) {
                if (state.finalWeight < 1) uncuffed = 2.5;
                else if (state.finalWeight < 2) uncuffed = 3.0;
                else uncuffed = 3.5;
            } else {
                if (calcAge < 1) uncuffed = 3.5;
                else uncuffed = (calcAge / 4) + 4;
            }
            if (uncuffed > 7.0) uncuffed = 7.0;
            const uncuffedDisplay = (Math.round(uncuffed * 2) / 2).toFixed(1);
            els.refEttUncuffed.innerText = uncuffedDisplay;

            let cuffed = uncuffed - 0.5;
            if (cuffed < 2.0) cuffed = 2.0;
            const cuffedDisplay = (Math.round(cuffed * 2) / 2).toFixed(1);
            els.refEttCuffed.innerText = cuffedDisplay;

            let depthStr = '';
            if (state.patientType === 'neonate') {
                depthStr = (state.finalWeight + 6).toFixed(1);
                els.refEttDepth.classList.remove('text-sm');
                els.refEttDepth.classList.add('text-lg');
            } else {
                if (state.inputMode === 'age') {
                    let d = 12 + (calcAge / 2);
                    depthStr = d.toFixed(1);
                    els.refEttDepth.classList.remove('text-sm');
                    els.refEttDepth.classList.add('text-lg');
                } else {
                    let dU = (uncuffed * 3).toFixed(1);
                    let dC = (cuffed * 3).toFixed(1);
                    depthStr = `U:${dU} C:${dC}`;
                    els.refEttDepth.classList.remove('text-lg');
                    els.refEttDepth.classList.add('text-sm');
                }
            }
            els.refEttDepth.innerText = depthStr;
        }

        function addListeners() {
            els.patientType.addEventListener('change', (e) => {
                state.patientType = e.target.value;
                updateInputVisibility();
                updateRouteOptions();
                calculate();
            });

            els.btnModeAge.addEventListener('click', () => {
                state.inputMode = 'age';
                updateInputVisibility();
                calculate();
            });
            els.btnModeWeight.addEventListener('click', () => {
                state.inputMode = 'weight';
                updateInputVisibility();
                calculate();
            });

            els.ageInput.addEventListener('input', (e) => {
                let val = parseFloat(e.target.value);
                // 修改邏輯：當數值 > 18 (超過上限) 時，保留最後輸入的那一位數
                // 這樣在手機上重新輸入時，就不會卡在 18，而是直接變成新的數字
                if (val > 18) {
                    const str = e.target.value;
                    const lastChar = str.slice(-1);
                    e.target.value = lastChar;
                    val = parseFloat(lastChar);
                }

                state.age = val;
                updateStateWeight();
                calculate();
            });

            els.weightInput.addEventListener('input', (e) => {
                let val = parseFloat(e.target.value);
                if (val > 100) {
                    const str = e.target.value;
                    const lastChar = str.slice(-1);
                    e.target.value = lastChar;
                    val = parseFloat(lastChar);
                }

                state.weightInput = e.target.value;
                updateStateWeight();
                calculate();
            });

            els.neonateWeightInput.addEventListener('input', (e) => {
                let val = parseFloat(e.target.value);
                if (val >= 10) {
                    const str = e.target.value;
                    const lastChar = str.slice(-1);
                    e.target.value = lastChar;
                    val = parseFloat(lastChar);
                }
                if (val > 5) {
                    val = 5;
                    e.target.value = 5;
                }
                state.neonateWeightInput = e.target.value;
                updateStateWeight();
                calculate();
            });

            els.interventionType.addEventListener('change', (e) => {
                state.intervention = e.target.value;
                updateInterventionUI();
                calculate();
            });

            els.reservedCategory.addEventListener('change', (e) => {
                state.category = e.target.value;
                updateRouteOptions();
                updateInterventionUI();
                calculate();
            });

            els.routeType.addEventListener('change', (e) => {
                state.route = e.target.value;
                updateInterventionUI();
                if (els.specificItem.options.length > 0) {
                    state.selectedItemId = els.specificItem.options[0].value;
                }
                calculate();
            });

            els.specificItem.addEventListener('change', (e) => {
                state.selectedItemId = e.target.value;
                calculate();
            });

            const modal = document.getElementById('modalDisclaimer');
            const btnOpen = document.getElementById('btnDisclaimer');
            const btnClose = document.getElementById('btnCloseModal');
            const btnConfirm = document.getElementById('btnConfirmModal');

            function toggleModal(show) {
                if (show) {
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            }

            if (btnOpen) btnOpen.addEventListener('click', () => toggleModal(true));
            if (btnClose) btnClose.addEventListener('click', () => toggleModal(false));
            if (btnConfirm) btnConfirm.addEventListener('click', () => toggleModal(false));

            window.addEventListener('click', (e) => {
                if (e.target === modal) toggleModal(false);
            });
        }

        init();
    </script>
</body>

</html>
